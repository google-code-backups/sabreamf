#summary How to deal with authentication
#labels Phase-Implementation

= What is it? =

Flash remoting has a standard way to deal with authentication. AMF0 and AMF3 deal with this differently, but this is abstracted in SabreAMF.

With the flash remoting components, you would use setCredentials(username,password) on the service object, in Flex you need to call setRemoteCredentials(username,password) on the RemoteObject to pass credentials.

= How to capture it? =

The servicebrowser has an onAuthenticate event you can use to capture the authentication.

We'll use the example from the CallbackServer page.

{{{
<?php

  // First we'll create the server object
  require_once 'SabreAMF/CallbackServer.php';
  $server = new SabreAMF_CallbackServer();

  // setup the callback
  $server->onInvokeService = 'myCallback';

  // parse the request and spit out the response
  $server->exec();

  function myCallback($serviceName, $methodName, $arguments) {

    // You can use the servicename to lookup and instantiate a service class
    $serviceObject = new $serviceName;

    // check the php manual if you don't know what this function does
    return call_user_func_array(array($serviceObject,$methodName),$arguments);

  }


?>
}}}

To add the authenticate event, we need to add the following line before `$server->exec()`.

{{{
<?php
  
   $server->onAuthenticate = 'myAuthFunction';

?>
}}}

The `myAuthFunction` should look like this:

{{{
<?

  function myAuthFunction($username, $password) {

     if ( /* authenticate the user */ ) {

        return true;

     } else {

        throw new Exception('User could not be logged in');

     }
         
  }

?>
}}}

= Use in practice = 

Overall authentication in AMF is badly designed, it's completely different in AMF0 and AMF3 and each method has nasty side effects.

  * AMF0: The username and password are sent over the wire for every single request as a header. It is however not easily possible to send back a 'login failed' message back, this would only really possible through the result of the actual method being called.
  * AMF3: The username and password are sent only once, and you can return a proper message if the user couldn't log in for some reason. However, there is no such thing as a session state, rendering authentication pretty much useless. It is possible to use cookies to maintain session information, but this does not work with Internet Explorer (tested on 6).

== Solutions ==

I'd strongly recommend building a custom login/session system. The easiest way to do this is by having a simple login service/method and returning a session id (or throw an exception when credentials are incorrect). 

After this always send along the session id with every AMF request. One common solution for this is to change the gateway url to include the session id. You can re-attach the request to the session by using php's [http://www.php.net/session_id session_id function]